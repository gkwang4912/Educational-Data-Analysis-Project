<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>數位學習平台分析報表</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: #202124; /* Dark background */
            color: #e8eaed; /* Light text */
            font-size: 16px; /* Increased base font size */
        }
        .dashboard-container {
            padding: 20px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #3c4043;
            margin-bottom: 20px;
        }
        .header-title {
            font-size: 28px; /* Increased */
            font-weight: 500;
        }
        .header-account-info {
            font-size: 14px; /* Increased */
            color: #9aa0a6;
            text-align: right;
        }
        .header-date-range {
            font-size: 16px; /* Increased */
            color: #bdc1c6;
        }
        .overview-bar {
            background-color: #3c4043; /* Slightly lighter than body */
            padding: 10px 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .overview-bar span {
            color: #8ab4f8; /* Highlight color for active tab */
            font-weight: 500;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background-color: #2d2e30; /* Card background */
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .metric-card-title {
            font-size: 20px; /* Increased */
            font-weight: 500;
            margin-bottom: 5px;
        }
        .metric-card-subtitle {
            font-size: 14px; /* Increased */
            color: #9aa0a6;
            margin-bottom: 15px;
        }
        .sub-metrics {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            gap: 10px;
        }
        .sub-metric-item {
            background-color: #3c4043;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            flex-grow: 1;
        }
        .sub-metric-item .value {
            font-size: 22px; /* Increased */
            font-weight: 500;
            color: #e8eaed;
        }
        .sub-metric-item .label {
            font-size: 14px; /* Increased */
            color: #9aa0a6;
        }
        .sub-metric-item .status {
            font-size: 12px; /* Increased */
            color: #80868b;
        }
        .chart-container {
            height: 500px; /* Increased height for larger charts */
        }

        .bottom-sections {
            display: grid;
            grid-template-columns: 2fr 1fr; /* Top Campaigns wider */
            gap: 20px;
        }
        .section-card {
            background-color: #2d2e30;
            padding: 20px;
            border-radius: 8px;
        }
        .section-card-title {
            font-size: 20px; /* Increased */
            font-weight: 500;
            margin-bottom: 5px;
        }
         .section-card-subtitle {
            font-size: 14px; /* Increased */
            color: #9aa0a6;
            margin-bottom: 15px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px; /* Increased */
        }
        th, td {
            text-align: left;
            padding: 8px 4px;
            border-bottom: 1px solid #3c4043;
        }
        th {
            color: #9aa0a6;
            font-weight: 500;
        }
        td {
            color: #e8eaed;
        }
        .table-footer {
            text-align: right;
            font-size: 14px; /* Increased */
            color: #9aa0a6;
            padding-top: 10px;
        }
        .device-breakdown-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px; /* Match chart height */
            color: #9aa0a6;
        }
        .device-breakdown-placeholder span {
            margin-top: 10px;
            font-size: 18px; /* Increased */
        }

    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <div>
                <div class="header-title">數位學習平台分析報表</div>
                <div class="header-account-info">Create by GK</div>
            </div>
            <div class="header-date-range">2025年5月14日 - 2025年6月1日</div>
        </div>

        <div class="overview-bar">
            <span>Overview</span>
        </div>

        <div class="metrics-grid">
            <!-- School Performance Comparison -->
            <div class="metric-card">
                <div class="metric-card-title">學校成績比較</div>
                <div class="metric-card-subtitle">五間學校的國文、英文、數學成績</div>
                <div class="chart-container" style="height: 600px;">
                    <canvas id="schoolComparisonChart"></canvas>
                </div>
            </div>

            <!-- 學力檢測比較 (MOVED) -->
            <div class="section-card">
                <div class="section-card-title">學力檢測比較</div>
                <table>
                    <thead>
                        <tr>
                            <th>學校代碼</th>
                            <th>最高分</th>
                            <th>最低分</th>
                            <th>標準差</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>1808</td><td>87</td><td>37</td><td>16.16</td></tr>
                        <tr><td>2486</td><td>97</td><td>37</td><td>20.16</td></tr>
                        <tr><td>338</td><td>97</td><td>30</td><td>15.74</td></tr>
                        <tr><td>3740</td><td>97</td><td>23</td><td>17.68</td></tr>
                        <tr><td>973</td><td>93</td><td>30</td><td>17.14</td></tr>
                    </tbody>
                </table>
                <div class="table-footer">1 - 5 / 5</div>

                <div class="metric-card-title" style="margin-top: 20px;">學校各科標準差比較</div>
                <div class="chart-container" style="height: 400px;"> <!-- Adjusted height for this new chart -->
                    <canvas id="schoolStdDevChart"></canvas>
                </div>
            </div>
        </div>

        <div class="bottom-sections">
            <!-- Subject Exercise Engagement (MOVED) -->
            <div class="metric-card">
                <div class="metric-card-title">科目練習參與度</div>
                <div class="metric-card-subtitle">顯示各個科目學生參與做題的次數</div>
                <div class="chart-container">
                    <canvas id="subjectEngagementChart"></canvas>
                </div>
            </div>

            <!-- 各科表現綜合雷達圖 -->
            <div class="section-card">
                <div class="section-card-title">各科表現綜合雷達圖</div>
                <div class="section-card-subtitle">顯示各科及格率</div>

                <div class="chart-container">
                    <canvas id="subjectPerformanceRadarChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const schoolDataPath = 'https://loadanalyize-830882540491.asia-east1.run.app/api/result/1_學校分析結果';
            const exerciseDataPath = 'https://loadanalyize-830882540491.asia-east1.run.app/api/result/2_練習題';

            const barChartOptions = (yLabel, tickColor, yMax = undefined) => ({
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        grid: { color: '#3c4043' },
                        ticks: { color: '#9aa0a6' }
                    },
                    y: {
                        title: { display: true, text: yLabel, color: '#e8eaed' },
                        grid: { color: '#3c4043' },
                        ticks: { color: tickColor || '#e8eaed', beginAtZero: true, max: yMax },
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: { color: '#e8eaed' }
                    }
                }
            });

            try {
                const [schoolResponse, exerciseResponse] = await Promise.all([
                    fetch(schoolDataPath),
                    fetch(exerciseDataPath)
                ]);

                if (!schoolResponse.ok) throw new Error(`無法載入 ${schoolDataPath}: ${schoolResponse.statusText}`);
                if (!exerciseResponse.ok) throw new Error(`無法載入 ${exerciseDataPath}: ${exerciseResponse.statusText}`);

                const schoolData = await schoolResponse.json();
                const exerciseData = await exerciseResponse.json();

                // --- 處理學校相關資料 ---
                const schoolMetrics = schoolData.map(school => ({
                    id: String(school.學校代碼).replace('.0', ''), // 清理學校ID
                    chineseAvg: parseFloat(school.國文測驗平均) || 0,
                    mathAvg: parseFloat(school.數學測驗平均) || 0,
                    englishAvg: parseFloat(school.英文測驗平均) || 0,
                    chineseStd: parseFloat(school.國文測驗標準差) || 0,
                    mathStd: parseFloat(school.數學測驗標準差) || 0,
                    englishStd: parseFloat(school.英文測驗標準差) || 0,
                    chineseMax: parseFloat(school.國文測驗最高分) || 0,
                    chineseMin: parseFloat(school.國文測驗最低分) || 0,
                    chinesePassRate: parseFloat(school.國文測驗及格率) || 0,
                    mathPassRate: parseFloat(school.數學測驗及格率) || 0,
                    englishPassRate: parseFloat(school.英文測驗及格率) || 0
                })).sort((a, b) => parseInt(a.id) - parseInt(b.id)); // 依學校ID進行數值排序

                const schoolComparisonLabels = schoolMetrics.map(s => s.id);

                // --- 渲染學校成績比較圖表 ---
                const chineseAverageScores = schoolMetrics.map(s => s.chineseAvg);
                const mathAverageScores = schoolMetrics.map(s => s.mathAvg);
                const englishAverageScores = schoolMetrics.map(s => s.englishAvg);

                new Chart(document.getElementById('schoolComparisonChart'), {
                    type: 'bar',
                    data: {
                        labels: schoolComparisonLabels,
                        datasets: [
                            { label: '國文平均分數', data: chineseAverageScores, backgroundColor: 'rgba(255, 99, 132, 0.8)', borderColor: 'rgb(255, 99, 132)', borderWidth: 1 },
                            { label: '數學平均分數', data: mathAverageScores, backgroundColor: 'rgba(85, 139, 47, 0.8)', borderColor: 'rgb(85, 139, 47)', borderWidth: 1 },
                            { label: '英文平均分數', data: englishAverageScores, backgroundColor: 'rgba(25, 118, 210, 0.8)', borderColor: 'rgb(25, 118, 210)', borderWidth: 1 }
                        ]
                    },
                    options: barChartOptions('平均分數', '#e8eaed', 100)
                });

                // --- 渲染學力檢測比較表格 ---
                const tableBody = document.querySelector('.section-card table tbody');
                tableBody.innerHTML = ''; // 清空現有表格內容
                schoolMetrics.forEach(schoolInfo => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = schoolInfo.id;
                    row.insertCell().textContent = schoolInfo.chineseMax;
                    row.insertCell().textContent = schoolInfo.chineseMin;
                    row.insertCell().textContent = schoolInfo.chineseStd.toFixed(2);
                });
                 const tableFooter = document.querySelector('.section-card .table-footer');
                 if(tableFooter) tableFooter.textContent = `1 - ${schoolMetrics.length} / ${schoolMetrics.length}`;


                // --- 渲染學校各科標準差比較圖表 ---
                const chineseStdDevData = schoolMetrics.map(s => s.chineseStd);
                const mathStdDevData = schoolMetrics.map(s => s.mathStd);
                const englishStdDevData = schoolMetrics.map(s => s.englishStd);

                new Chart(document.getElementById('schoolStdDevChart'), {
                    type: 'bar',
                    data: {
                        labels: schoolComparisonLabels,
                        datasets: [
                            { label: '國文測驗標準差', data: chineseStdDevData, backgroundColor: 'rgba(255, 159, 64, 0.8)', borderColor: 'rgb(255, 159, 64)', borderWidth: 1 },
                            { label: '數學測驗標準差', data: mathStdDevData, backgroundColor: 'rgba(75, 192, 192, 0.8)', borderColor: 'rgb(75, 192, 192)', borderWidth: 1 },
                            { label: '英文測驗標準差', data: englishStdDevData, backgroundColor: 'rgba(153, 102, 255, 0.8)', borderColor: 'rgb(153, 102, 255)', borderWidth: 1 }
                        ]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            x: { title: { display: true, text: '標準差', color: '#e8eaed' }, grid: { color: '#3c4043' }, ticks: { color: '#9aa0a6', beginAtZero: true } },
                            y: { grid: { color: '#3c4043' }, ticks: { color: '#e8eaed' } }
                        },
                        plugins: { legend: { display: true, position: 'top', labels: { color: '#e8eaed' } } }
                    }
                });

                // --- 處理並渲染科目練習參與度圖表 ---
                const targetSubjects = ['國語文108', '數學108', '自然108', '健康與體育', '防災', '資訊', '音樂'];
                const filteredExerciseData = exerciseData
                    .filter(item => targetSubjects.includes(item.科目名稱))
                    .map(item => ({ ...item, 作答次數: parseFloat(item.作答次數) || 0 }))
                    .sort((a, b) => b.作答次數 - a.作答次數);

                const subjectEngagementLabels = filteredExerciseData.map(item => item.科目名稱);
                const subjectEngagementData = filteredExerciseData.map(item => item.作答次數);

                new Chart(document.getElementById('subjectEngagementChart'), {
                    type: 'bar',
                    data: {
                        labels: subjectEngagementLabels,
                        datasets: [{
                            label: '作答次數',
                            data: subjectEngagementData,
                            backgroundColor: 'rgba(205, 164, 52, 0.8)',
                            borderColor: 'rgb(205, 164, 52)',
                            borderWidth: 1
                        }]
                    },
                    options: barChartOptions('作答次數', '#e8eaed', Math.max(...subjectEngagementData, 0) * 1.1 || 100)
                });

                // --- 處理並渲染各科表現綜合雷達圖 ---
                const numSchools = schoolMetrics.length || 1; // 避免除以零
                const avgChinesePassRate = schoolMetrics.reduce((sum, s) => sum + s.chinesePassRate, 0) / numSchools;
                const avgMathPassRate = schoolMetrics.reduce((sum, s) => sum + s.mathPassRate, 0) / numSchools;
                const avgEnglishPassRate = schoolMetrics.reduce((sum, s) => sum + s.englishPassRate, 0) / numSchools;

                const exerciseSubjectAvgCorrectness = {};
                exerciseData.forEach(item => {
                    exerciseSubjectAvgCorrectness[item.科目名稱] = parseFloat(item.平均正確率) || 0;
                });
                
                const radarChartLabels = ['國文', '英語', '數學', '自然', '社會', '資訊教育', '音樂', '健康與體育', '海洋與環境'];
                const studentPassRates = radarChartLabels.map(label => {
                    let rate = 0;
                    switch (label) {
                        case '國文':
                            rate = avgChinesePassRate;
                            break;
                        case '數學':
                            rate = avgMathPassRate;
                            break;
                        case '英語': // '英語' 標籤對應 '英文' 相關數據
                            rate = avgEnglishPassRate;
                            break;
                        default:
                            if (exerciseSubjectAvgCorrectness.hasOwnProperty(label)) {
                                rate = exerciseSubjectAvgCorrectness[label];
                            } else if (label === '自然' && exerciseSubjectAvgCorrectness.hasOwnProperty('自然108')) {
                                rate = exerciseSubjectAvgCorrectness['自然108'];
                            } else if (label === '英文' && exerciseSubjectAvgCorrectness.hasOwnProperty('英語108')) { // 備用，如果標籤用“英文”
                                rate = exerciseSubjectAvgCorrectness['英語108'];
                            }
                            // 可以根據需要添加更多科目名稱的映射邏輯
                            break;
                    }
                    return parseFloat(rate.toFixed(2));
                });
                
                new Chart(document.getElementById('subjectPerformanceRadarChart'), {
                    type: 'radar',
                    data: {
                        labels: radarChartLabels,
                        datasets: [{
                            label: '學生平均及格率 (%)',
                            data: studentPassRates,
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1,
                            pointBackgroundColor: 'rgba(255, 99, 132, 1)'
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            r: {
                                angleLines: { color: '#3c4043' },
                                grid: { color: '#3c4043' },
                                pointLabels: { color: '#e8eaed', font: { size: 12 } },
                                ticks: { color: '#e8eaed', backdropColor: '#202124', beginAtZero: true, max: 100 }
                            }
                        },
                        plugins: {
                            legend: { position: 'top', labels: { color: '#e8eaed' } },
                            tooltip: { bodyColor: '#e8eaed', titleColor: '#e8eaed', borderColor: '#3c4043', borderWidth: 1 }
                        }
                    }
                });

            } catch (error) {
                console.error("載入或處理儀表板資料時發生錯誤:", error);
                const container = document.querySelector('.dashboard-container');
                if (container) {
                    // 清空容器並顯示錯誤訊息
                    while (container.firstChild) {
                        container.removeChild(container.firstChild);
                    }
                    const errorP = document.createElement('p');
                    errorP.style.color = "red";
                    errorP.style.textAlign = "center";
                    errorP.style.padding = "20px";
                    errorP.textContent = `載入儀表板資料時發生錯誤: ${error.message}. 請檢查 JSON 檔案是否存在且格式正確，路徑為 json_output/1_學校分析結果.json 和 json_output/2_練習題.json。同時確認瀏覽器主控台以獲取更多資訊。`;
                    container.appendChild(errorP);
                }
            }
        });
    </script>
</body>
</html>
